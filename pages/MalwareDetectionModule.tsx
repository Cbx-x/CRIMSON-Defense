
import React, { useState, useEffect } from 'react';
import { Smartphone, FileCode, AlertTriangle, ShieldCheck, Cpu, Zap, Activity, Code } from 'lucide-react';
import { AreaChart, Area, XAxis, YAxis, Tooltip, ResponsiveContainer, RadarChart, PolarGrid, PolarAngleAxis, PolarRadiusAxis, Radar } from 'recharts';

const MalwareDetectionModule: React.FC = () => {
  const [appType, setAppType] = useState<'benign' | 'malware'>('benign');
  const [dynamicData, setDynamicData] = useState<any[]>([]);
  const [malwareProb, setMalwareProb] = useState(0.05);

  // Simulation Data
  const benignPermissions = ['INTERNET', 'ACCESS_NETWORK_STATE', 'VIBRATE'];
  const malwarePermissions = ['SEND_SMS', 'READ_CONTACTS', 'RECORD_AUDIO', 'SYSTEM_ALERT_WINDOW', 'RECEIVE_BOOT_COMPLETED'];
  
  const benignApis = ['HttpUrlConnection', 'RecyclerView', 'Glide'];
  const malwareApis = ['DexClassLoader', 'TelephonyManager.getDeviceId', 'SmsManager.sendTextMessage', 'Runtime.exec'];

  useEffect(() => {
    // Reset data when switching types
    setDynamicData([]); 
  }, [appType]);

  useEffect(() => {
    const interval = setInterval(() => {
      setDynamicData(prev => {
        // Malware typically has higher CPU usage (mining/encryption) and bursts of network activity (exfiltration)
        const cpuBase = appType === 'malware' ? 65 : 15;
        const netBase = appType === 'malware' ? 450 : 20;
        
        const newCpu = Math.max(0, Math.min(100, cpuBase + (Math.random() * 20 - 10)));
        const newNet = Math.max(0, netBase + (Math.random() * 200 - 100));

        // Update probability based on sustained behavior
        setMalwareProb(prevProb => {
             const target = appType === 'malware' ? 0.92 : 0.04;
             return prevProb + (target - prevProb) * 0.1;
        });

        const newData = [...prev, { 
            time: new Date().toLocaleTimeString([], {minute: '2-digit', second:'2-digit'}), 
            cpu: newCpu,
            network: newNet 
        }];
        return newData.slice(-30);
      });
    }, 1000);

    return () => clearInterval(interval);
  }, [appType]);

  const radarData = [
    { subject: 'Permissions', A: appType === 'malware' ? 90 : 20, fullMark: 100 },
    { subject: 'API Calls', A: appType === 'malware' ? 85 : 30, fullMark: 100 },
    { subject: 'CPU Usage', A: appType === 'malware' ? 70 : 15, fullMark: 100 },
    { subject: 'Network', A: appType === 'malware' ? 80 : 10, fullMark: 100 },
    { subject: 'Battery', A: appType === 'malware' ? 60 : 10, fullMark: 100 },
    { subject: 'Storage', A: appType === 'malware' ? 40 : 20, fullMark: 100 },
  ];

  return (
    <div className="p-8 space-y-8 max-w-7xl mx-auto">
      <div className="flex justify-between items-start border-b border-white/10 pb-6">
        <div>
           <h1 className="text-2xl font-bold font-display text-white mb-1">MALICIOUS APP DETECTION</h1>
           <p className="text-zinc-400">Hybrid Analysis (Static + Dynamic) using XGBoost & LSTM</p>
        </div>
        <div className="bg-black p-1 rounded-lg border border-white/10 flex">
            <button 
              onClick={() => setAppType('benign')}
              className={`px-4 py-2 rounded text-sm font-medium transition-colors ${appType === 'benign' ? 'bg-emerald-600 text-white shadow-[0_0_10px_#10b981]' : 'text-zinc-500 hover:text-zinc-300'}`}
            >
              Simulate Benign App
            </button>
            <button 
              onClick={() => setAppType('malware')}
              className={`px-4 py-2 rounded text-sm font-medium transition-colors ${appType === 'malware' ? 'bg-crimson-600 text-white shadow-[0_0_10px_#e11d48]' : 'text-zinc-500 hover:text-zinc-300'}`}
            >
              Simulate Malware
            </button>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        {/* Left: Static Analysis */}
        <div className="space-y-6">
            <h2 className="text-lg font-semibold text-white flex items-center gap-2 font-display">
                <FileCode className="w-5 h-5 text-crimson-500" /> 1. Static Feature Extraction
            </h2>
            
            <div className="bg-zinc-900/50 border border-white/10 rounded-xl p-5 space-y-6 backdrop-blur-sm">
                <div>
                    <div className="flex justify-between items-center mb-2">
                        <span className="text-xs font-bold text-zinc-500 uppercase font-mono">Manifest Permissions</span>
                        <span className="text-xs text-zinc-400">{appType === 'malware' ? 'High Risk' : 'Low Risk'}</span>
                    </div>
                    <div className="flex flex-wrap gap-2">
                        {(appType === 'malware' ? malwarePermissions : benignPermissions).map(p => (
                            <span key={p} className={`px-2 py-1 rounded text-[10px] font-mono border ${
                                appType === 'malware' && malwarePermissions.includes(p) 
                                ? 'bg-crimson-900/30 border-crimson-500/30 text-crimson-400' 
                                : 'bg-black border-white/10 text-zinc-400'
                            }`}>
                                {p}
                            </span>
                        ))}
                    </div>
                </div>

                <div>
                    <div className="flex justify-between items-center mb-2">
                        <span className="text-xs font-bold text-zinc-500 uppercase font-mono">Suspicious API Calls</span>
                    </div>
                    <ul className="space-y-2">
                        {(appType === 'malware' ? malwareApis : benignApis).map(api => (
                            <li key={api} className="flex items-center gap-2 text-xs text-zinc-300 font-mono bg-black p-2 rounded border border-white/10">
                                <Code className="w-3 h-3 text-crimson-500" />
                                {api}
                            </li>
                        ))}
                    </ul>
                </div>
            </div>
            
            <div className="bg-zinc-900/50 border border-white/10 p-6 rounded-xl backdrop-blur-sm">
                 <h3 className="text-sm font-semibold text-white mb-4 text-center font-display">FEATURE VECTOR FOOTPRINT</h3>
                 <div className="h-48">
                    <ResponsiveContainer width="100%" height="100%">
                        <RadarChart cx="50%" cy="50%" outerRadius="70%" data={radarData}>
                            <PolarGrid stroke="#3f3f46" />
                            <PolarAngleAxis dataKey="subject" tick={{ fill: '#71717a', fontSize: 10, fontFamily: 'monospace' }} />
                            <PolarRadiusAxis angle={30} domain={[0, 100]} tick={false} axisLine={false} />
                            <Radar
                                name="App Profile"
                                dataKey="A"
                                stroke={appType === 'malware' ? "#f43f5e" : "#10b981"}
                                fill={appType === 'malware' ? "#f43f5e" : "#10b981"}
                                fillOpacity={0.3}
                            />
                        </RadarChart>
                    </ResponsiveContainer>
                 </div>
            </div>
        </div>

        {/* Center: Dynamic Analysis */}
        <div className="lg:col-span-2 space-y-6">
            <h2 className="text-lg font-semibold text-white flex items-center gap-2 font-display">
                <Activity className="w-5 h-5 text-crimson-500" /> 2. Behavioral Monitoring (Dynamic)
            </h2>
            
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                 {/* CPU Chart */}
                 <div className="bg-zinc-900/50 border border-white/10 rounded-xl p-5 backdrop-blur-sm">
                    <div className="flex justify-between items-center mb-4">
                        <div className="flex items-center gap-2">
                             <Cpu className="w-4 h-4 text-amber-500" />
                             <span className="text-sm font-medium text-zinc-200 font-display">CPU USAGE</span>
                        </div>
                        <span className="text-xs font-mono text-zinc-400">
                            {dynamicData.length > 0 ? dynamicData[dynamicData.length - 1].cpu.toFixed(1) : 0}%
                        </span>
                    </div>
                    <div className="h-32">
                        <ResponsiveContainer width="100%" height="100%">
                            <AreaChart data={dynamicData}>
                                <defs>
                                    <linearGradient id="colorCpu" x1="0" y1="0" x2="0" y2="1">
                                        <stop offset="5%" stopColor="#f59e0b" stopOpacity={0.3}/>
                                        <stop offset="95%" stopColor="#f59e0b" stopOpacity={0}/>
                                    </linearGradient>
                                </defs>
                                <XAxis dataKey="time" hide />
                                <YAxis domain={[0, 100]} hide />
                                <Area type="monotone" dataKey="cpu" stroke="#f59e0b" fillOpacity={1} fill="url(#colorCpu)" />
                            </AreaChart>
                        </ResponsiveContainer>
                    </div>
                 </div>

                 {/* Network Chart */}
                 <div className="bg-zinc-900/50 border border-white/10 rounded-xl p-5 backdrop-blur-sm">
                    <div className="flex justify-between items-center mb-4">
                        <div className="flex items-center gap-2">
                             <Zap className="w-4 h-4 text-blue-500" />
                             <span className="text-sm font-medium text-zinc-200 font-display">DATA USAGE</span>
                        </div>
                        <span className="text-xs font-mono text-zinc-400">
                             {dynamicData.length > 0 ? dynamicData[dynamicData.length - 1].network.toFixed(0) : 0} Kbps
                        </span>
                    </div>
                    <div className="h-32">
                        <ResponsiveContainer width="100%" height="100%">
                            <AreaChart data={dynamicData}>
                                <defs>
                                    <linearGradient id="colorNet" x1="0" y1="0" x2="0" y2="1">
                                        <stop offset="5%" stopColor="#3b82f6" stopOpacity={0.3}/>
                                        <stop offset="95%" stopColor="#3b82f6" stopOpacity={0}/>
                                    </linearGradient>
                                </defs>
                                <XAxis dataKey="time" hide />
                                <YAxis hide />
                                <Area type="monotone" dataKey="network" stroke="#3b82f6" fillOpacity={1} fill="url(#colorNet)" />
                            </AreaChart>
                        </ResponsiveContainer>
                    </div>
                 </div>
            </div>

            {/* Inference Pipeline */}
            <div className="bg-zinc-900/50 border border-white/10 rounded-xl p-6 backdrop-blur-sm">
                <div className="flex justify-between items-center mb-6">
                    <h3 className="text-sm font-medium text-zinc-200 font-display">ENSEMBLE MODEL PIPELINE</h3>
                    <span className="text-xs text-zinc-500 bg-black px-2 py-1 rounded border border-white/5 font-mono">
                        Inference Time: 12ms (NPU)
                    </span>
                </div>

                <div className="flex items-center gap-2 mb-6 text-xs text-zinc-400 font-mono bg-black p-3 rounded overflow-x-auto border border-white/5">
                    <span className="text-crimson-400">Input Vector:</span>
                    [
                    {appType === 'malware' ? '1, 1, 0, 1' : '0, 0, 1, 0'},{' '}  
                    {appType === 'malware' ? '0.85' : '0.12'},{' '} 
                    {appType === 'malware' ? '412' : '20'},{' '}
                    ...
                    ]
                </div>

                <div className="flex items-stretch gap-4 h-24">
                     <div className="flex-1 bg-zinc-800 rounded border border-white/5 flex flex-col items-center justify-center p-2 relative">
                         <div className="text-xs font-bold text-zinc-300 mb-1">XGBoost</div>
                         <div className="text-[10px] text-zinc-500 text-center font-mono">Static Analysis</div>
                         <div className={`absolute bottom-0 h-1 w-full rounded-b ${appType === 'malware' ? 'bg-crimson-500' : 'bg-emerald-500'}`}></div>
                     </div>
                     <div className="text-zinc-600 flex items-center font-bold">+</div>
                     <div className="flex-1 bg-zinc-800 rounded border border-white/5 flex flex-col items-center justify-center p-2 relative">
                         <div className="text-xs font-bold text-zinc-300 mb-1">LSTM</div>
                         <div className="text-[10px] text-zinc-500 text-center font-mono">Dynamic Behavior</div>
                         <div className={`absolute bottom-0 h-1 w-full rounded-b ${appType === 'malware' ? 'bg-crimson-500' : 'bg-emerald-500'}`}></div>
                     </div>
                     <div className="text-zinc-600 flex items-center font-bold">=</div>
                     <div className={`flex-1 rounded border flex flex-col items-center justify-center p-2 transition-colors duration-500
                        ${malwareProb > 0.5 ? 'bg-crimson-900/20 border-crimson-500/50' : 'bg-emerald-900/20 border-emerald-500/50'}`}>
                         <div className="text-xs font-bold text-zinc-300 mb-1 font-mono uppercase">Score</div>
                         <div className={`text-2xl font-bold font-display ${malwareProb > 0.5 ? 'text-crimson-500' : 'text-emerald-500'}`}>
                             {(malwareProb * 100).toFixed(1)}%
                         </div>
                     </div>
                </div>
            </div>
        </div>

      </div>

      <div className="bg-zinc-900/50 border border-white/10 p-6 rounded-xl backdrop-blur-sm">
           <h3 className="text-white font-semibold mb-4 font-display">ARCHITECTURE DECISION: HYBRID SCANNING</h3>
           <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
               <div className="space-y-2">
                   <h4 className="text-sm font-medium text-emerald-500 font-mono">On-Device (Privacy & Speed)</h4>
                   <ul className="text-xs text-zinc-400 space-y-2 list-disc pl-4">
                       <li><strong>Model:</strong> TFLite Quantized (XGBoost + LSTM).</li>
                       <li><strong>Function:</strong> Real-time behavioral monitoring and basic static analysis.</li>
                       <li><strong>Pros:</strong> Works offline, preserves battery, zero data latency, user privacy.</li>
                   </ul>
               </div>
               <div className="space-y-2">
                   <h4 className="text-sm font-medium text-crimson-500 font-mono">Cloud (Deep Inspection)</h4>
                   <ul className="text-xs text-zinc-400 space-y-2 list-disc pl-4">
                       <li><strong>Model:</strong> Large Language Models (Gemini) + Graph Neural Networks.</li>
                       <li><strong>Function:</strong> Deobfuscation, CFG (Control Flow Graph) analysis, and zero-day correlation.</li>
                       <li><strong>Trigger:</strong> Only sends metadata/hashes if On-Device score {'>'} 0.7 to verify suspicious apps.</li>
                   </ul>
               </div>
           </div>
      </div>
    </div>
  );
};

export default MalwareDetectionModule;
